<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Google Maps Polygon Tool</title>
    <!-- Inter font from Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Tailwind CSS CDN for styling -->
    <!-- <script src="https://cdn.tailwindcss.com"></script> -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f9;
        }
        #map {
            width: 100%;
            min-height: 500px;
            height: 70vh;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .text-section {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .btn-primary {
            @apply bg-blue-600 text-white font-medium py-2 px-4 rounded-lg shadow-lg hover:bg-blue-700 transition duration-300 ease-in-out;
        }
        .btn-secondary {
            @apply bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-lg shadow-lg hover:bg-gray-400 transition duration-300 ease-in-out;
        }
        .btn-red {
            @apply bg-red-600 text-white font-medium py-2 px-4 rounded-lg shadow-lg hover:bg-red-700 transition duration-300 ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 sm:p-8">
    <div class="container mx-auto max-w-7xl">
        <header class="mb-8 text-center">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">Polygon Drawing Tool</h1>
            <p class="text-gray-600">Draw a polygon on the map, and save its coordinates.</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Map and Controls Section -->
            <section class="lg:col-span-2 flex flex-col space-y-4">
                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4">
                    <div id="map"></div>
                    <input type="text" id="fieldNameInput" placeholder="Enter polygon name" class="shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full rounded-md sm:text-sm border-gray-300 p-2">
                    <button id="saveJsonBtn" class="btn-primary flex-grow">
                        Save as JSON
                    </button>
                    <button id="saveLocalBtn" class="btn-primary flex-grow">
                        Save to Local Storage
                    </button>
                    <button id="loadLocalBtn" class="btn-primary flex-grow">
                        Load from Local Storage
                    </button>
                    <button id="clearBtn" class="btn-red flex-grow">
                        Clear All
                    </button>
                </div>
            </section>

            <!-- Coordinates Display Section -->
            <!-- <aside class="lg:col-span-1">
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                    <h2 class="text-2xl font-bold mb-4 text-gray-800">Polygon Coordinates</h2>
                    <p class="text-sm text-gray-500 mb-4">
                        Draw a polygon on the map, and its coordinates will be displayed here.
                    </p>
                    <div class="bg-gray-50 p-4 rounded-lg text-sm text-gray-700 overflow-auto max-h-96 text-section border border-gray-100">
                        <pre id="coordinates-output">No polygon drawn yet.</pre>
                    </div>
                </div>
            </aside> -->
        </main>

        <!-- Message Box -->
        <div id="message-box" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50">
            <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
                <p id="message-text" class="text-lg font-medium text-gray-800 mb-4"></p>
                <button onclick="document.getElementById('message-box').style.display='none'" class="btn-primary w-full">
                    OK
                </button>
            </div>
        </div>
    </div>

    <!-- Google Maps API script -->
    <script>
        // IMPORTANT: Replace "YOUR_API_KEY" with a valid API key from your Google Cloud Console.
        // Ensure that the "Maps JavaScript API" and "Drawing Library" are enabled for your project.
        const apiKey = "AIzaSyA3vUl0jnyrAi_awYheUAYjFNDKCUaDpeU";

        let map;
        let drawingManager;
        let currentPolygon = null;

        // Function to display a custom message box instead of using alert()
        function showMessage(message) {
            document.getElementById('message-text').innerText = message;
            document.getElementById('message-box').style.display = 'flex';
        }

        // Add listeners for path changes to a given polygon
        function addPolygonListeners(polygon) {
            if (!polygon) return;
            
            const path = polygon.getPath();
            
            // Listen for changes to the polygon's vertices (move, add, or delete a point)
            google.maps.event.addListener(path, 'set_at', () => {
                displayPolygonCoordinates(polygon);
            });
            google.maps.event.addListener(path, 'insert_at', () => {
                displayPolygonCoordinates(polygon);
            });
            google.maps.event.addListener(path, 'remove_at', () => {
                displayPolygonCoordinates(polygon);
            });
        }

        // Initialize the map and drawing manager
        function initMap() {
            // Check if google maps object is available
            if (typeof google === 'undefined' || typeof google.maps === 'undefined') {
                 showMessage("Failed to load Google Maps API. Please ensure your API key is valid and the libraries are enabled.");
                 return;
            }

            const mapOptions = {
                center: { lat: 39.8283, lng: -98.5795 }, // Center of the US
                zoom: 4,
                mapTypeId: 'satellite',
                mapTypeControl: false,
                streetViewControl: false,
                fullscreenControl: false
            };
            map = new google.maps.Map(document.getElementById('map'), mapOptions);

            // Initialize the DrawingManager
            drawingManager = new google.maps.drawing.DrawingManager({
                drawingMode: google.maps.drawing.OverlayType.POLYGON,
                drawingControl: true,
                drawingControlOptions: {
                    position: google.maps.ControlPosition.TOP_CENTER,
                    drawingModes: ['polygon']
                },
                polygonOptions: {
                    strokeColor: '#008CFF',
                    strokeOpacity: 0.8,
                    strokeWeight: 2,
                    fillColor: '#008CFF',
                    fillOpacity: 0.35,
                    editable: true
                }
            });
            drawingManager.setMap(map);

            // Listen for a new polygon being created
            google.maps.event.addListener(drawingManager, 'polygoncomplete', function(polygon) {
                if (currentPolygon) {
                    currentPolygon.setMap(null); // Remove previous polygon
                }
                currentPolygon = polygon;
                drawingManager.setDrawingMode(null); // Stop drawing mode
                displayPolygonCoordinates(currentPolygon);
                addPolygonListeners(currentPolygon);
            });
        }

        // // Display the coordinates of the polygon in the pre tag
        // function displayPolygonCoordinates(polygon) {
        //     if (!polygon) {
        //         document.getElementById('coordinates-output').innerText = "No polygon drawn yet.";
        //         return;
        //     }
        //     const paths = polygon.getPath();
        //     const coordinates = [];
        //     paths.forEach(point => {
        //         coordinates.push({ lat: point.lat(), lng: point.lng() });
        //     });
        //     const output = JSON.stringify(coordinates, null, 2);
        //     document.getElementById('coordinates-output').innerText = output;
        // }

        // Convert the polygon's path to an array of coordinates
        function getPolygonCoordinates() {
            if (!currentPolygon) return null;
            const path = currentPolygon.getPath();
            const coordinates = [];
            path.forEach(latLng => {
                coordinates.push({ lat: latLng.lat(), lng: latLng.lng() });
            });
            return coordinates;
        }

        // Save the current polygon data as a JSON file
        function saveAsJson() {
            const fieldName = document.getElementById('fieldNameInput').value.trim();
            const coordinates = getPolygonCoordinates();
            if (!coordinates || coordinates.length < 3) {
                showMessage("Please draw a polygon with at least 3 points before saving.");
                return;
            }
            if (!fieldName) {
                showMessage("Please enter a polygon name before saving.");
                return;
            }
            const data = {
                fieldName: fieldName,
                coordinates: coordinates
            };
            const jsonString = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${fieldName.replace(/ /g, '_')}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Save the current polygon coordinates to local storage
        function saveToLocalStorage() {
            if (!currentPolygon) {
                showMessage("No polygon to save. Please draw one first.");
                return;
            }
            const coordinates = getPolygonCoordinates();
            try {
                localStorage.setItem('savedPolygon', JSON.stringify(coordinates));
                showMessage("Polygon coordinates saved to local storage!");
            } catch (e) {
                console.error("Failed to save to local storage:", e);
                showMessage("Failed to save. Local storage might be full or disabled.");
            }
        }

        // Load polygon coordinates from local storage and draw it on the map
        function loadFromLocalStorage() {
            try {
                const savedCoordinatesString = localStorage.getItem('savedPolygon');
                if (!savedCoordinatesString) {
                    showMessage("No saved polygon found in local storage.");
                    return;
                }
                const savedCoordinates = JSON.parse(savedCoordinatesString);
                if (currentPolygon) {
                    currentPolygon.setMap(null);
                }
                currentPolygon = new google.maps.Polygon({
                    paths: savedCoordinates,
                    strokeColor: '#008CFF',
                    strokeOpacity: 0.8,
                    strokeWeight: 2,
                    fillColor: '#008CFF',
                    fillOpacity: 0.35,
                    editable: true,
                    map: map,
                });
                currentPolygon.setMap(map);
                addPolygonListeners(currentPolygon);
                displayPolygonCoordinates(currentPolygon);
                const bounds = new google.maps.LatLngBounds();
                currentPolygon.getPath().forEach(point => bounds.extend(point));
                map.fitBounds(bounds);
                showMessage("Polygon loaded from local storage!");
            } catch (e) {
                console.error("Failed to load from local storage:", e);
                showMessage("Failed to load data. The data in local storage might be corrupted.");
            }
        }
        
        // Clear the polygon, map, and local storage
        function clearAll() {
            if (currentPolygon) {
                currentPolygon.setMap(null);
                currentPolygon = null;
            }
            localStorage.removeItem('savedPolygon');
            document.getElementById('fieldNameInput').value = '';
            displayPolygonCoordinates(null);
            if (drawingManager) {
                drawingManager.setDrawingMode(google.maps.drawing.OverlayType.POLYGON);
            }
            showMessage("Map and local storage cleared.");
        }

        // Attach event listeners to the buttons
        document.getElementById('saveJsonBtn').addEventListener('click', saveAsJson);
        document.getElementById('saveLocalBtn').addEventListener('click', saveToLocalStorage);
        document.getElementById('loadLocalBtn').addEventListener('click', loadFromLocalStorage);
        document.getElementById('clearBtn').addEventListener('click', clearAll);

        // Load the Google Maps script with the drawing library and a callback to initMap
        const script = document.createElement('script');
        script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=drawing&callback=initMap`;
        script.async = true;
        document.head.appendChild(script);
    </script>
</body>
</html>
