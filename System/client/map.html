<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Plot Field on Map</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet"/>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: 'Inter', sans-serif;
      background-color: #f7f7f9;
    }
    .map-container {
      padding: 30px 100px 40px;
    }
    .title {
      margin-bottom: 20px;
    }
    #map {
      width: 100%;
      height: 400px;
      border-radius: 0.5rem;
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
      margin-bottom: 20px;
    }
    .map-btn {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .map-btn input,
    .map-btn button {
      padding: 0.75rem 1rem;
      font-size: 1rem;
      border-radius: 0.5rem;
    }
    .map-btn input {
      border: 1px solid #ccc;
    }
    .btn-primary {
      background-color: #2563eb;
      color: #fff;
      border: none;
      cursor: pointer;
    }
    .btn-primary:hover {
      background-color: #1e40af;
    }
    .btn-red {
      background-color: #ef4444;
      color: #fff;
      border: none;
      cursor: pointer;
    }
    .btn-red:hover {
      background-color: #dc2626;
    }
    #message-box {
      position: fixed;
      inset: 0;
      background-color: rgba(17,24,39,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }
    .message-box-content {
      background-color: #fff;
      padding: 1.5rem;
      border-radius: 0.5rem;
      box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
      max-width: 24rem;
      width: 100%;
      text-align: center;
    }
    .message-box-content p {
      font-size: 1.125rem;
      font-weight: 500;
      color: #1f2937;
      margin-bottom: 1rem;
    }
  </style>
</head>
<body>
  <div class="map-container">
    <header class="title">
      <h1>Plot Your Field</h1>
      <p>Draw a polygon on the map, and save its coordinates.</p>
    </header>

    <div id="map"></div>

    <div class="map-btn">
      <input type="text" id="fieldNameInput" placeholder="Enter polygon name"/>
      <button id="saveJsonBtn" class="btn-primary">Save as JSON</button>
      <button id="saveLocalBtn" class="btn-primary">Save to Local Storage</button>
      <button id="loadLocalBtn" class="btn-primary">Load from Local Storage</button>
      <button id="clearBtn" class="btn-red">Clear All</button>
    </div>
  </div>

  <div id="message-box">
    <div class="message-box-content">
      <p id="message-text"></p>
      <button onclick="document.getElementById('message-box').style.display='none'" class="btn-primary">OK</button>
    </div>
  </div>

  <script>
    const apiKey = "AIzaSyA3vUl0jnyrAi_awYheUAYjFNDKCUaDpeU";
    let map;
    let drawingManager;
    let currentPolygon = null;

    function showMessage(message) {
      document.getElementById('message-text').innerText = message;
      document.getElementById('message-box').style.display = 'flex';
    }

    function getPolygonCoordinates() {
      if (!currentPolygon) return null;
      const path = currentPolygon.getPath();
      const coordinates = [];
      path.forEach(latLng => {
        coordinates.push({ lat: latLng.lat(), lng: latLng.lng() });
      });
      return coordinates;
    }

    function saveAsJson() {
      const fieldName = document.getElementById('fieldNameInput').value.trim();
      const coordinates = getPolygonCoordinates();
      if (!coordinates || coordinates.length < 3) {
        showMessage("Draw a polygon with at least 3 points.");
        return;
      }
      if (!fieldName) {
        showMessage("Enter a name before saving.");
        return;
      }
      const data = { fieldName, coordinates };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `${fieldName.replace(/ /g, '_')}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    function saveToLocalStorage() {
      if (!currentPolygon) {
        showMessage("No polygon to save.");
        return;
      }
      localStorage.setItem('savedPolygon', JSON.stringify(getPolygonCoordinates()));
      showMessage("Saved to local storage!");
    }

    function loadFromLocalStorage() {
      const saved = localStorage.getItem('savedPolygon');
      if (!saved) {
        showMessage("No saved polygon found.");
        return;
      }
      const coords = JSON.parse(saved);
      if (currentPolygon) currentPolygon.setMap(null);
      currentPolygon = new google.maps.Polygon({
        paths: coords,
        strokeColor: '#2563eb',
        strokeOpacity: 0.8,
        strokeWeight: 2,
        fillColor: '#2563eb',
        fillOpacity: 0.35,
        editable: true,
        map: map,
      });
      const bounds = new google.maps.LatLngBounds();
      currentPolygon.getPath().forEach(p => bounds.extend(p));
      map.fitBounds(bounds);
      showMessage("Polygon loaded.");
    }

    function clearAll() {
      if (currentPolygon) {
        currentPolygon.setMap(null);
        currentPolygon = null;
      }
      localStorage.removeItem('savedPolygon');
      document.getElementById('fieldNameInput').value = '';
      if (drawingManager) {
        drawingManager.setDrawingMode(google.maps.drawing.OverlayType.POLYGON);
      }
      showMessage("Cleared.");
    }

    function initMap() {
      if (typeof google === 'undefined' || typeof google.maps === 'undefined') {
        showMessage("Google Maps failed to load.");
        return;
      }

      map = new google.maps.Map(document.getElementById('map'), {
        center: { lat: 20.5937, lng: 78.9629 },
        zoom: 5,
        mapTypeId: 'satellite',
        mapTypeControl: false,
        streetViewControl: false,
        fullscreenControl: false
      });

      drawingManager = new google.maps.drawing.DrawingManager({
        drawingMode: google.maps.drawing.OverlayType.POLYGON,
        drawingControl: true,
        drawingControlOptions: {
          position: google.maps.ControlPosition.TOP_CENTER,
          drawingModes: ['polygon']
        },
        polygonOptions: {
          strokeColor: '#2563eb',
          strokeOpacity: 0.8,
          strokeWeight: 2,
          fillColor: '#2563eb',
          fillOpacity: 0.35,
          editable: true
        }
      });

      drawingManager.setMap(map);

      google.maps.event.addListener(drawingManager, 'polygoncomplete', function(polygon) {
        if (currentPolygon) currentPolygon.setMap(null);
        currentPolygon = polygon;
        drawingManager.setDrawingMode(null);
      });
    }

    // Ensure initMap is globally accessible
    window.initMap = initMap;

    // Dynamically load Google Maps script
    const script = document.createElement('script');
    script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=drawing&callback=initMap`;
    script.async = true;
    script.defer = true;
    script.onerror = () => showMessage("Failed to load Google Maps.");
    document.head.appendChild(script);

    // Attach button listeners after DOM is ready
    window.addEventListener('DOMContentLoaded', () => {
      document.getElementById('saveJsonBtn').addEventListener('click', saveAsJson);
      document.getElementById('saveLocalBtn').addEventListener('click', saveToLocalStorage);
      document.getElementById('loadLocalBtn').addEventListener('click', loadFromLocalStorage);
      document.getElementById('clearBtn').addEventListener('click', clearAll);
    });
  </script>
</body>
</html>